name: Daily decisions call

on:
  schedule:
    # 6AM EST (UTC-05:00) = 11:00 UTC, weekdays
    - cron: "0 11 * * 1-5"
  workflow_dispatch:

jobs:
  call-decisions-endpoint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - portfolio_id: "00000000-0000-0000-0000-000000000001"
            model_type: linear-regression
            forecast_horizon: EOY
          - portfolio_id: "00000000-0000-0000-0000-000000000002"
            model_type: random-forest-regression
            forecast_horizon: EOY
          - portfolio_id: "00000000-0000-0000-0000-000000000003"
            model_type: linear-regression
            forecast_horizon: 30d
          - portfolio_id: "00000000-0000-0000-0000-000000000004"
            model_type: random-forest-regression
            forecast_horizon: 30d
          - portfolio_id: "00000000-0000-0000-0000-000000000005"
            model_type: linear-regression
            forecast_horizon: EOY
          - portfolio_id: "00000000-0000-0000-0000-000000000006"
            model_type: random-forest-regression
            forecast_horizon: EOY
          - portfolio_id: "00000000-0000-0000-0000-000000000007"
            model_type: linear-regression
            forecast_horizon: 30d
          - portfolio_id: "00000000-0000-0000-0000-000000000008"
            model_type: random-forest-regression
            forecast_horizon: 30d
          - portfolio_id: "00000000-0000-0000-0000-000000000009"
            model_type: linear-regression
            forecast_horizon: EOY
          - portfolio_id: "00000000-0000-0000-0000-000000000010"
            model_type: random-forest-regression
            forecast_horizon: EOY
          - portfolio_id: "00000000-0000-0000-0000-000000000011"
            model_type: linear-regression
            forecast_horizon: 30d
          - portfolio_id: "00000000-0000-0000-0000-000000000012"
            model_type: random-forest-regression
            forecast_horizon: 30d
    env:
      API_BASE_URL: ${{ secrets.DECISIONS_API_BASE_URL || 'https://investment-advisor-backend-ssf6.onrender.com' }}
    steps:
      - name: Call /api/decisions
        run: |
          set -euo pipefail
          payload=$(jq -n \
            --arg portfolio_id "${{ matrix.portfolio_id }}" \
            --arg model_type "${{ matrix.model_type }}" \
            --arg forecast_horizon "${{ matrix.forecast_horizon }}" \
            '{portfolio_id: $portfolio_id, model_type: $model_type, forecast_horizon: $forecast_horizon}')
          echo "Calling $API_BASE_URL/api/decisions with payload: $payload"
          curl -sS -X POST "$API_BASE_URL/api/decisions" \
            -H 'Content-Type: application/json' \
            -d "$payload"
